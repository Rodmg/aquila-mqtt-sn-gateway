{"version":3,"sources":["../src/GwMonitor.ts"],"names":[],"mappings":"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","file":"GwMonitor.js","sourcesContent":["\nimport { EventEmitter } from 'events';\nimport { Gateway } from './Gateway';\nimport { log } from './Logger';\n\nexport class GwMonitor extends EventEmitter {\n\n  gateway: Gateway;\n  prefix: string;\n\n  _onMessage: any;\n  _onDeviceConnected: any;\n  _onDeviceDisconnected: any;\n  _onDevicePaired: any;\n\n  constructor(gateway: Gateway, prefix?: string) {\n    super();\n    \n    // Monitor topics prefix\n    this.prefix = prefix;\n    if(this.prefix == null) this.prefix = 'gw';\n\n    this.gateway = gateway;\n\n    this.gateway.client.subscribe(this.prefix + '/devices/get');\n    this.gateway.client.subscribe(this.prefix + '/subscriptions/get');\n    this.gateway.client.subscribe(this.prefix + '/topics/get');\n    this.gateway.client.subscribe(this.prefix + '/forwarder/enterpair');\n    this.gateway.client.subscribe(this.prefix + '/forwarder/exitpair');\n    this.gateway.client.subscribe(this.prefix + '/forwarder/mode/get');\n\n    this._onMessage = (topic: string, message: Buffer, packet: any) => this.onMessage(topic, message, packet);\n    this._onDeviceConnected = (device: any) => this.onDeviceConnected(device);\n    this._onDeviceDisconnected = (device: any) => this.onDeviceDisconnected(device);\n    this._onDevicePaired = (device: any) => this.onDevicePaired(device);\n\n    this.gateway.client.on('message', this._onMessage);\n    this.gateway.on('deviceConnected', this._onDeviceConnected);\n    this.gateway.on('deviceDisconnected', this._onDeviceDisconnected);\n    this.gateway.forwarder.on('devicePaired', this._onDevicePaired);\n\n  }\n\n  destructor() {\n    this.gateway.client.unsubscribe(this.prefix + '/devices/get');\n    this.gateway.client.unsubscribe(this.prefix + '/subscriptions/get');\n    this.gateway.client.unsubscribe(this.prefix + '/topics/get');\n    this.gateway.client.unsubscribe(this.prefix + '/forwarder/enterpair');\n    this.gateway.client.unsubscribe(this.prefix + '/forwarder/exitpair');\n    this.gateway.client.unsubscribe(this.prefix + '/forwarder/mode/get');\n\n    this.gateway.client.removeListener('message', this._onMessage);\n    this.gateway.removeListener('deviceConnected', this._onDeviceConnected);\n    this.gateway.removeListener('deviceDisconnected', this._onDeviceDisconnected);\n    this.gateway.forwarder.removeListener('devicePaired', this._onDevicePaired);\n\n    delete this.gateway;\n  }\n\n  async onMessage(topic: string, message: Buffer, packet: any) {\n    if(topic === this.prefix + '/devices/get') {\n      let temp;\n      try {\n        temp = await this.gateway.db.getAllDevices();\n      }\n      catch(err) {\n        return log.error(err);\n      }\n      let devices = JSON.parse(JSON.stringify(temp));  // make copy, fixes crash with lokijs\n      // Cleanup\n      for(let i in devices) {\n        delete devices[i].meta;\n        delete devices[i].$loki;\n      }\n      this.gateway.client.publish(this.prefix + '/devices/res', JSON.stringify(devices));\n    }\n\n    if(topic === this.prefix + '/subscriptions/get') {\n      let temp;\n      try {\n        temp = await this.gateway.db.getAllSubscriptions();\n      }\n      catch(err) {\n        return log.error(err);\n      }\n      let subscriptions = JSON.parse(JSON.stringify(temp));  // make copy, fixes crash with lokijs\n      // Cleanup\n      for(let i in subscriptions) {\n        delete subscriptions[i].meta;\n        delete subscriptions[i].$loki;\n      }\n      this.gateway.client.publish(this.prefix + '/subscriptions/res', JSON.stringify(subscriptions));\n    }\n\n    if(topic === this.prefix + '/topics/get') {\n      let temp;\n      try {\n        temp = await this.gateway.db.getAllTopics();\n      }\n      catch(err) {\n        return log.error(err);\n      }\n      let topics = JSON.parse(JSON.stringify(temp));  // make copy, fixes crash with lokijs\n      // Cleanup\n      for(let i in topics) {\n        delete topics[i].meta;\n        delete topics[i].$loki;\n      }\n      this.gateway.client.publish(this.prefix + '/topics/res', JSON.stringify(topics));\n    }\n\n    if(topic === this.prefix + '/forwarder/enterpair') {\n      this.gateway.forwarder.enterPairMode();\n    }\n\n    if(topic === this.prefix + '/forwarder/exitpair') {\n      this.gateway.forwarder.exitPairMode();\n    }\n\n    if(topic === this.prefix + '/forwarder/mode/get') {\n      let mode = this.gateway.forwarder.getMode();\n      this.gateway.client.publish(this.prefix + '/forwarder/mode/res', JSON.stringify({ mode: mode }));\n    }\n  }\n\n  onDeviceConnected(device: any) {\n    let dev = JSON.parse(JSON.stringify(device));\n    delete dev.meta;\n    delete dev.$loki;\n    this.gateway.client.publish(this.prefix + '/devices/connected', JSON.stringify(dev));\n  }\n\n  onDeviceDisconnected(device: any) {\n    let dev = JSON.parse(JSON.stringify(device));\n    delete dev.meta;\n    delete dev.$loki;\n    this.gateway.client.publish(this.prefix + '/devices/disconnected', JSON.stringify(dev));\n  }\n\n  onDevicePaired(device: any) {\n    let dev = JSON.parse(JSON.stringify(device));\n    delete dev.meta;\n    delete dev.$loki;\n    this.gateway.client.publish(this.prefix + '/devices/paired', JSON.stringify(dev));\n  }\n\n}\n"],"sourceRoot":"/Users/rod/workshop/aquila-gateway/src"}